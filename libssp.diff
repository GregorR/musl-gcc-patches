# HG changeset patch
# Parent 05108195ceea1303837469f4217a993d0b0caf40
libssp is provided in musl libc.

diff -r 05108195ceea gcc/configure
--- a/gcc/configure	Tue Aug 27 15:44:40 2013 -0400
+++ b/gcc/configure	Tue Aug 27 15:46:34 2013 -0400
@@ -26815,7 +26815,8 @@
          gcc_cv_libc_provides_ssp=yes
       fi
 	;;
-       *-*-gnu*)
+       *-*-gnu* | \
+       *-linux-musl*)
 	 # Avoid complicated tests (see
 	 # <http://gcc.gnu.org/ml/gcc/2008-10/msg00130.html>) and for now
 	 # simply assert that glibc does provide this, which is true for all
diff -r 05108195ceea gcc/configure.ac
--- a/gcc/configure.ac	Tue Aug 27 15:44:40 2013 -0400
+++ b/gcc/configure.ac	Tue Aug 27 15:46:34 2013 -0400
@@ -4692,7 +4692,8 @@
          gcc_cv_libc_provides_ssp=yes
       fi]
 	;;
-       *-*-gnu*)
+       *-*-gnu* | \
+       *-linux-musl*)
 	 # Avoid complicated tests (see
 	 # <http://gcc.gnu.org/ml/gcc/2008-10/msg00130.html>) and for now
 	 # simply assert that glibc does provide this, which is true for all
@@ -4762,6 +4763,9 @@
       gcc_cv_target_dl_iterate_phdr=no
     fi
     ;;
+  *-linux-musl*)
+    gcc_cv_target_dl_iterate_phdr=yes
+    ;;
 esac
 GCC_TARGET_TEMPLATE([TARGET_DL_ITERATE_PHDR])
 if test x$gcc_cv_target_dl_iterate_phdr = xyes; then
diff -r 05108195ceea libssp/Makefile.am
--- a/libssp/Makefile.am	Tue Aug 27 15:44:40 2013 -0400
+++ b/libssp/Makefile.am	Tue Aug 27 15:46:34 2013 -0400
@@ -36,7 +36,11 @@
 
 AM_CFLAGS = -Wall
 
+if LIBSSP_IN_LIBC
+toolexeclib_LTLIBRARIES = libssp_nonshared.la
+else
 toolexeclib_LTLIBRARIES = libssp.la libssp_nonshared.la
+endif
 
 target_noncanonical = @target_noncanonical@
 libsubincludedir = $(libdir)/gcc/$(target_noncanonical)/$(gcc_version)/include
diff -r 05108195ceea libssp/Makefile.in
--- a/libssp/Makefile.in	Tue Aug 27 15:44:40 2013 -0400
+++ b/libssp/Makefile.in	Tue Aug 27 15:46:34 2013 -0400
@@ -93,12 +93,17 @@
 libssp_la_LINK = $(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) \
 	$(LIBTOOLFLAGS) --mode=link $(CCLD) $(AM_CFLAGS) $(CFLAGS) \
 	$(libssp_la_LDFLAGS) $(LDFLAGS) -o $@
+@LIBSSP_IN_LIBC_FALSE@am_libssp_la_rpath = -rpath $(toolexeclibdir)
 am_libssp_nonshared_la_OBJECTS = libssp_nonshared_la-ssp-local.lo
 libssp_nonshared_la_OBJECTS = $(am_libssp_nonshared_la_OBJECTS)
 libssp_nonshared_la_LINK = $(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) \
 	$(LIBTOOLFLAGS) --mode=link $(CCLD) \
 	$(libssp_nonshared_la_CFLAGS) $(CFLAGS) \
 	$(libssp_nonshared_la_LDFLAGS) $(LDFLAGS) -o $@
+@LIBSSP_IN_LIBC_FALSE@am_libssp_nonshared_la_rpath = -rpath \
+@LIBSSP_IN_LIBC_FALSE@	$(toolexeclibdir)
+@LIBSSP_IN_LIBC_TRUE@am_libssp_nonshared_la_rpath = -rpath \
+@LIBSSP_IN_LIBC_TRUE@	$(toolexeclibdir)
 DEFAULT_INCLUDES = -I.@am__isrc@
 depcomp = $(SHELL) $(top_srcdir)/../depcomp
 am__depfiles_maybe = depfiles
@@ -258,7 +263,8 @@
 @LIBSSP_USE_SYMVER_GNU_TRUE@@LIBSSP_USE_SYMVER_TRUE@version_dep = $(srcdir)/ssp.map
 @LIBSSP_USE_SYMVER_SUN_TRUE@@LIBSSP_USE_SYMVER_TRUE@version_dep = ssp.map-sun
 AM_CFLAGS = -Wall
-toolexeclib_LTLIBRARIES = libssp.la libssp_nonshared.la
+@LIBSSP_IN_LIBC_FALSE@toolexeclib_LTLIBRARIES = libssp.la libssp_nonshared.la
+@LIBSSP_IN_LIBC_TRUE@toolexeclib_LTLIBRARIES = libssp_nonshared.la
 libsubincludedir = $(libdir)/gcc/$(target_noncanonical)/$(gcc_version)/include
 nobase_libsubinclude_HEADERS = ssp/ssp.h ssp/string.h ssp/stdio.h ssp/unistd.h
 libssp_la_SOURCES = \
@@ -414,9 +420,9 @@
 	  rm -f "$${dir}/so_locations"; \
 	done
 libssp.la: $(libssp_la_OBJECTS) $(libssp_la_DEPENDENCIES) 
-	$(libssp_la_LINK) -rpath $(toolexeclibdir) $(libssp_la_OBJECTS) $(libssp_la_LIBADD) $(LIBS)
+	$(libssp_la_LINK) $(am_libssp_la_rpath) $(libssp_la_OBJECTS) $(libssp_la_LIBADD) $(LIBS)
 libssp_nonshared.la: $(libssp_nonshared_la_OBJECTS) $(libssp_nonshared_la_DEPENDENCIES) 
-	$(libssp_nonshared_la_LINK) -rpath $(toolexeclibdir) $(libssp_nonshared_la_OBJECTS) $(libssp_nonshared_la_LIBADD) $(LIBS)
+	$(libssp_nonshared_la_LINK) $(am_libssp_nonshared_la_rpath) $(libssp_nonshared_la_OBJECTS) $(libssp_nonshared_la_LIBADD) $(LIBS)
 
 mostlyclean-compile:
 	-rm -f *.$(OBJEXT)
diff -r 05108195ceea libssp/configure
--- a/libssp/configure	Tue Aug 27 15:44:40 2013 -0400
+++ b/libssp/configure	Tue Aug 27 15:46:34 2013 -0400
@@ -626,6 +626,8 @@
 ssp_have_usable_vsnprintf
 EGREP
 GREP
+LIBSSP_IN_LIBC_FALSE
+LIBSSP_IN_LIBC_TRUE
 LIBSSP_USE_SYMVER_SUN_FALSE
 LIBSSP_USE_SYMVER_SUN_TRUE
 LIBSSP_USE_SYMVER_GNU_FALSE
@@ -735,6 +737,7 @@
 enable_multilib
 enable_dependency_tracking
 enable_symvers
+enable_ssp_in_libc
 enable_shared
 enable_static
 with_pic
@@ -1374,6 +1377,7 @@
   --disable-dependency-tracking  speeds up one-time build
   --enable-dependency-tracking   do not reject slow dependency extractors
   --disable-symvers       disable symbol versioning for libssp
+  --enable-ssp-in-libc    do not build SSP, as it is in libc
   --enable-shared[=PKGS]  build shared libraries [default=yes]
   --enable-static[=PKGS]  build static libraries [default=yes]
   --enable-fast-install[=PKGS]
@@ -4206,6 +4210,36 @@
 fi
 
 
+# musl provides libssp in libc
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether libssp is provided in libc" >&5
+$as_echo_n "checking whether libssp is provided in libc... " >&6; }
+# Check whether --enable-ssp_in_libc was given.
+if test "${enable_ssp_in_libc+set}" = set; then :
+  enableval=$enable_ssp_in_libc; ssp_in_libc=$enableval
+else
+  ssp_in_libc=check
+fi
+
+if test "x$ssp_in_libc" = "xcheck"; then
+  case "$host" in
+    *-musl*)
+      ssp_in_libc=yes
+      ;;
+
+    *)
+      ssp_in_libc=no
+      ;;
+  esac
+fi
+ if test "x$ssp_in_libc" = xyes; then
+  LIBSSP_IN_LIBC_TRUE=
+  LIBSSP_IN_LIBC_FALSE='#'
+else
+  LIBSSP_IN_LIBC_TRUE='#'
+  LIBSSP_IN_LIBC_FALSE=
+fi
+
+
 
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for grep that handles long lines and -e" >&5
 $as_echo_n "checking for grep that handles long lines and -e... " >&6; }
@@ -10650,7 +10684,7 @@
   lt_dlunknown=0; lt_dlno_uscore=1; lt_dlneed_uscore=2
   lt_status=$lt_dlunknown
   cat > conftest.$ac_ext <<_LT_EOF
-#line 10653 "configure"
+#line 10687 "configure"
 #include "confdefs.h"
 
 #if HAVE_DLFCN_H
@@ -10756,7 +10790,7 @@
   lt_dlunknown=0; lt_dlno_uscore=1; lt_dlneed_uscore=2
   lt_status=$lt_dlunknown
   cat > conftest.$ac_ext <<_LT_EOF
-#line 10759 "configure"
+#line 10793 "configure"
 #include "confdefs.h"
 
 #if HAVE_DLFCN_H
@@ -11185,6 +11219,10 @@
   as_fn_error "conditional \"LIBSSP_USE_SYMVER_SUN\" was never defined.
 Usually this means the macro was only invoked conditionally." "$LINENO" 5
 fi
+if test -z "${LIBSSP_IN_LIBC_TRUE}" && test -z "${LIBSSP_IN_LIBC_FALSE}"; then
+  as_fn_error "conditional \"LIBSSP_IN_LIBC\" was never defined.
+Usually this means the macro was only invoked conditionally." "$LINENO" 5
+fi
 
 : ${CONFIG_STATUS=./config.status}
 ac_write_fail=0
diff -r 05108195ceea libssp/configure.ac
--- a/libssp/configure.ac	Tue Aug 27 15:44:40 2013 -0400
+++ b/libssp/configure.ac	Tue Aug 27 15:46:34 2013 -0400
@@ -114,6 +114,26 @@
 AM_CONDITIONAL(LIBSSP_USE_SYMVER_GNU, [test "x$ssp_use_symver" = xgnu])
 AM_CONDITIONAL(LIBSSP_USE_SYMVER_SUN, [test "x$ssp_use_symver" = xsun])
 
+# musl provides libssp in libc
+AC_MSG_CHECKING([whether libssp is provided in libc])
+AC_ARG_ENABLE(ssp_in_libc,
+AC_HELP_STRING([--enable-ssp-in-libc],
+  [do not build SSP, as it is in libc]),
+ssp_in_libc=$enableval,
+ssp_in_libc=check)
+if test "x$ssp_in_libc" = "xcheck"; then
+  case "$host" in
+    *-musl*)
+      ssp_in_libc=yes
+      ;;
+
+    *)
+      ssp_in_libc=no
+      ;;
+  esac
+fi
+AM_CONDITIONAL(LIBSSP_IN_LIBC, [test "x$ssp_in_libc" = xyes])
+
 AC_CHECK_HEADERS(alloca.h malloc.h paths.h syslog.h string.h unistd.h fcntl.h stdio.h limits.h)
 
 if test x$gcc_no_link = xyes; then
