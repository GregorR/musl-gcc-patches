# HG changeset patch
# Parent ed5df7a8910d0149d720efa8734d1dcadc02a620
Support for arm-linux-musl.

diff -r ed5df7a8910d gcc/config/arm/linux-eabi.h
--- a/gcc/config/arm/linux-eabi.h	Tue Sep 17 14:41:53 2013 -0400
+++ b/gcc/config/arm/linux-eabi.h	Tue Sep 17 14:44:27 2013 -0400
@@ -77,6 +77,28 @@
     %{mfloat-abi=soft*:" GLIBC_DYNAMIC_LINKER_SOFT_FLOAT "} \
     %{!mfloat-abi=*:" GLIBC_DYNAMIC_LINKER_DEFAULT "}"
 
+/* For ARM musl currently supports two dynamic linkers:
+   - ld-musl-arm.so.1 - for the EABI-derived soft-float ABI
+   - ld-musl-armhf.so.1 - for the EABI-derived hard-float ABI.
+   musl does not support the legacy OABI (i.e. broken) mode.
+   All the dynamic linkers live in /lib.
+   We default to soft-float, but this can be overridden by changing both
+   MUSL_DYNAMIC_LINKER_DEFAULT and TARGET_DEFAULT_FLOAT_ABI.  */
+#undef  MUSL_DYNAMIC_LINKER
+#if TARGET_ENDIAN_DEFAULT == 0 /* LE */
+#define MUSL_DYNAMIC_LINKER_SOFT_FLOAT "/lib/ld-musl-arm.so.1"
+#define MUSL_DYNAMIC_LINKER_HARD_FLOAT "/lib/ld-musl-armhf.so.1"
+#else /* BE */
+#define MUSL_DYNAMIC_LINKER_SOFT_FLOAT "/lib/ld-musl-armeb.so.1"
+#define MUSL_DYNAMIC_LINKER_HARD_FLOAT "/lib/ld-musl-armebhf.so.1"
+#endif
+#define MUSL_DYNAMIC_LINKER_DEFAULT MUSL_DYNAMIC_LINKER_SOFT_FLOAT
+
+#define MUSL_DYNAMIC_LINKER \
+  "%{mfloat-abi=hard:" MUSL_DYNAMIC_LINKER_HARD_FLOAT "} \
+   %{mfloat-abi=soft*:" MUSL_DYNAMIC_LINKER_SOFT_FLOAT "} \
+   %{!mfloat-abi=*:" MUSL_DYNAMIC_LINKER_DEFAULT "}"
+
 /* At this point, bpabi.h will have clobbered LINK_SPEC.  We want to
    use the GNU/Linux version, not the generic BPABI version.  */
 #undef  LINK_SPEC
diff -r ed5df7a8910d libitm/config/arm/hwcap.cc
--- a/libitm/config/arm/hwcap.cc	Tue Sep 17 14:41:53 2013 -0400
+++ b/libitm/config/arm/hwcap.cc	Tue Sep 17 14:44:27 2013 -0400
@@ -40,7 +40,11 @@
 
 #ifdef __linux__
 #include <unistd.h>
+#ifdef __GLIBC__
 #include <sys/fcntl.h>
+#else
+#include <fcntl.h>
+#endif
 #include <elf.h>
 
 static void __attribute__((constructor))
